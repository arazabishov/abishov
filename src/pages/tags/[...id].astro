---
import BlogCard from "@/components/cards/BlogCard.astro";
import ProjectCard from "@/components/cards/ProjectCard.astro";
import Breadcrumbs from "@/components/navigation/Breadcrumbs.astro";
import Layout from "@/layouts/Layout.astro";
import { getAllTags, getPostsByTag, getProjectsByTag } from "@/core/content";

export async function getStaticPaths() {
  const tagMap = await getAllTags();
  const uniqueTags = Array.from(tagMap.keys());

  return Promise.all(
    uniqueTags.map(async (tag) => {
      const posts = await getPostsByTag(tag);
      const projects = await getProjectsByTag(tag);
      return {
        params: { id: tag },
        props: {
          tag,
          posts,
          projects,
        },
      };
    }),
  );
}

const { tag, posts, projects } = Astro.props;
---

<Layout
  title={`Tagged "${tag}"`}
  description={`Posts and projects tagged with ${tag}.`}
  noindex
  class="max-w-3xl"
>
  <Breadcrumbs
    items={[
      { href: "/tags", label: "Tags", icon: "lucide:tags" },
      { label: tag, icon: "lucide:tag" },
    ]}
  />

  <div class="space-y-8">
    {
      posts.length > 0 && (
        <section class="space-y-4">
          <h2 class="text-xl font-medium">Posts</h2>
          <ul class="flex flex-col gap-y-4">
            {posts.map((post) => (
              <li>
                <BlogCard entry={post} />
              </li>
            ))}
          </ul>
        </section>
      )
    }

    {
      projects.length > 0 && (
        <section class="space-y-4">
          <h2 class="text-xl font-medium">Projects</h2>
          <div class="grid items-start gap-6 sm:grid-cols-2">
            {projects.map((project) => (
              <ProjectCard project={project} />
            ))}
          </div>
        </section>
      )
    }
  </div>
</Layout>
