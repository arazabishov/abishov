---
import Button from "@/components/ui/Button.astro";
import { Icon } from "astro-icon/components";
---

<Button id="theme-toggle" variant="ghost" size="icon" title="Toggle theme" class="-my-2 -me-2 size-8">
  <Icon name="lucide:sun" class="size-4 dark:hidden" />
  <Icon name="lucide:moon" class="absolute hidden size-4 dark:block" />
  <span class="sr-only">Toggle theme</span>
</Button>

<!--
  Theme initialization script.
  - is:inline: Executes immediately (before page render) to prevent theme flash.
  - data-astro-rerun: Re-executes on every navigation (required with ClientRouter).
-->
<script is:inline data-astro-rerun>
  (() => {
    const theme = (() => {
      const stored = localStorage?.getItem("theme") ?? "";

      if (["dark", "light"].includes(stored)) {
        return stored;
      }

      return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
    })();

    document.documentElement.setAttribute("data-theme", theme);
    window.localStorage.setItem("theme", theme);
  })();
</script>

<script>
  function handleToggleClick() {
    const element = document.documentElement;
    const currentTheme = element.getAttribute("data-theme");
    const newTheme = currentTheme === "dark" ? "light" : "dark";

    // Temporarily disable transitions to prevent jarring color changes during theme switch.
    // getComputedStyle forces a style recalculation (reflow) before re-enabling transitions.
    element.classList.add("[&_*]:transition-none");
    element.setAttribute("data-theme", newTheme);
    window.getComputedStyle(element).getPropertyValue("opacity");

    requestAnimationFrame(() => {
      element.classList.remove("[&_*]:transition-none");
    });

    localStorage.setItem("theme", newTheme);
  }

  function initThemeToggle() {
    document.getElementById("theme-toggle")?.addEventListener("click", handleToggleClick);
  }

  initThemeToggle();

  // Re-apply theme after Astro's view transition swaps the DOM.
  // Without this, navigating to a new page would reset to light theme.
  document.addEventListener("astro:after-swap", () => {
    const storedTheme = localStorage.getItem("theme") || "light";
    const element = document.documentElement;

    element.classList.add("[&_*]:transition-none");
    window.getComputedStyle(element).getPropertyValue("opacity");
    element.setAttribute("data-theme", storedTheme);

    requestAnimationFrame(() => {
      element.classList.remove("[&_*]:transition-none");
    });

    initThemeToggle();
  });
</script>
