---
import { getHeadingMargin } from "@/core/utils";
import type { MarkdownHeading } from "astro";
import { Icon } from "astro-icon/components";

type Props = {
  headings: MarkdownHeading[];
};

const { headings } = Astro.props;
---

{
  headings && headings.length > 0 && (
    <div id="mobile-toc-container" class="w-full xl:hidden">
      <details class="group">
        <summary class="flex w-full cursor-pointer items-center justify-between">
          <div class="mx-auto flex w-full max-w-3xl items-center px-4 py-3">
            <div class="relative mr-2 size-4">
              <svg class="h-4 w-4" viewBox="0 0 24 24">
                <circle
                  class="text-primary/20"
                  cx="12"
                  cy="12"
                  r="10"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                />
                <circle
                  id="mobile-toc-progress-circle"
                  class="text-primary"
                  cx="12"
                  cy="12"
                  r="10"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-dasharray="62.83"
                  stroke-dashoffset="62.83"
                  transform="rotate(-90 12 12)"
                />
              </svg>
            </div>
            <span
              id="mobile-toc-current-section"
              class="text-muted-foreground flex-grow truncate text-sm"
            >
              Overview
            </span>
            <span class="text-muted-foreground ml-2">
              <Icon
                name="lucide:chevron-down"
                class="h-4 w-4 transition-transform duration-200 group-open:rotate-180"
              />
            </span>
          </div>
        </summary>

        <div
          id="mobile-toc-scroll-area"
          class="mx-auto max-w-3xl max-h-[30vh] overflow-y-auto"
        >
          <ul
            class="flex list-none flex-col gap-y-2 px-4 pb-4"
            id="mobile-table-of-contents"
          >
            {headings.map((heading) => (
              <li
                class:list={[
                  "px-4 text-sm",
                  getHeadingMargin(heading.depth),
                  "text-foreground/60",
                ]}
              >
                <a
                  href={`#${heading.slug}`}
                  class="mobile-toc-item underline decoration-transparent underline-offset-[3px] transition-colors duration-200 hover:decoration-inherit"
                  data-heading-id={heading.slug}
                >
                  {heading.text}
                </a>
              </li>
            ))}
          </ul>
        </div>
      </details>
    </div>
  )
}

<script>
  import { initMobileTOC } from "@/scripts/toc";

  let cleanup: (() => void) | undefined;

  function init() {
    cleanup?.();
    cleanup = initMobileTOC();
  }

  document.addEventListener("astro:page-load", init);
  document.addEventListener("astro:before-swap", () => cleanup?.());
</script>
